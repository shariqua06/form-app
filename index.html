<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Farmer Subsidy Application Form</title>
<style>
  body { font-family: Arial, sans-serif; background: #f9f9f9; margin: 0; padding: 20px; }
  .container { max-width: 480px; margin: auto; background: white; padding: 25px; box-shadow: 0 0 15px rgba(0,0,0,0.1); border-radius: 8px; }
  h2 { text-align: center; margin-bottom: 20px; }
  label { display: block; margin-top: 15px; font-weight: bold; }
  input[type="text"], select { width: 100%; padding: 8px 10px; margin-top: 6px; border: 1px solid #ccc; border-radius: 4px; }
  button { margin-top: 10px; padding: 8px 12px; border: none; background: #4CAF50; color: white; font-size: 14px; cursor: pointer; border-radius: 4px; }
  button:disabled { background: #999; cursor: not-allowed; }
  #video { width: 100%; border-radius: 8px; margin-top: 10px; border: 1px solid #ccc; }
  #aadhaarNumber { font-weight: bold; }
</style>
</head>
<body>
<div class="container">
  <h2>Farmer Subsidy Application Form</h2>
  <form id="form">
    <label for="name">Name</label>
    <input id="name" placeholder="Enter Name" autocomplete="off" />
    <button type="button" id="voiceName">Speak Name</button>

    <label for="location">Farm Location</label>
    <input id="location" placeholder="Enter Farm Location" autocomplete="off" />
    <button type="button" id="voiceLocation">Speak Location</button>

    <label for="subsidyType">Subsidy Type</label>
    <select id="subsidyType">
      <option value="">-- Select Subsidy --</option>
      <option value="urimam">Urimam (Fertilizer)</option>
      <option value="parivu">Parivu (Irrigation)</option>
      <option value="vidhai">Vidhai (Seed)</option>
      <option value="ubagaranam">Ubagaranam (Equipment)</option>
    </select>
    <button type="button" id="voiceSubsidy">Speak Subsidy Type</button>

    <label for="amount">Amount</label>
    <input id="amount" placeholder="Enter Amount" autocomplete="off" />
    <button type="button" id="voiceAmount">Speak Amount</button>

    <label>Aadhaar Card (Show to Camera)</label>
    <video id="video" autoplay muted playsinline></video>
    <input id="aadhaarNumber" placeholder="Aadhaar Number will auto-fill here" readonly />
    <small style="color:gray;">Please hold Aadhaar card steady in front of camera</small>

    <button type="submit">Submit</button>
  </form>
</div>

<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
<script>
const video = document.getElementById('video');
const aadhaarInput = document.getElementById('aadhaarNumber');
const form = document.getElementById('form');
const canvas = document.createElement('canvas');
const ctx = canvas.getContext('2d');
let workerReady = false;
let ocrWorker;

// Safe creation & termination of Tesseract worker to prevent data clone errors
async function initWorker() {
  if (ocrWorker) await ocrWorker.terminate();
  ocrWorker = Tesseract.createWorker({
    logger: m => console.log(m)
  });
  await ocrWorker.load();
  await ocrWorker.loadLanguage('eng');
  await ocrWorker.initialize('eng');
  workerReady = true;
}
initWorker();

// Start camera with proper options for mobile (playsinline needed)
navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
  .then(stream => { video.srcObject = stream; })
  .catch(err => alert('Camera access required: ' + err));

// Periodic OCR scanning with delay and error handling
async function scanFrame() {
  if (!workerReady) return setTimeout(scanFrame, 2000);
  if (video.readyState !== 4) return setTimeout(scanFrame, 2000);
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  ctx.drawImage(video, 0, 0);
  const dataURL = canvas.toDataURL('image/png');
  try {
    const { data: { text } } = await ocrWorker.recognize(dataURL);
    const match = text.match(/\bd{4}s*d{4}s*d{4}\b/);
    if (match) {
      const cleanNum = match[0].replace(/s/g, '');
      if (aadhaarInput.value !== cleanNum) {
        aadhaarInput.value = cleanNum;
        console.log('Aadhaar detected: ', cleanNum);
      }
    }
  } catch(e) {
    console.error('OCR error:', e);
    // Reinitialize worker if error occurs to avoid lockup
    workerReady = false;
    initWorker();
  }
  setTimeout(scanFrame, 3000);
}
scanFrame();

// Voice Synthesis: tamil transliteration + english, using en-US locale to improve pronunciation
const synth = window.speechSynthesis;
function speakPrompt(tamilTranslit, englishText, onEnd) {
  if (synth.speaking) synth.cancel();
  const tamilUtter = new SpeechSynthesisUtterance(tamilTranslit);
  tamilUtter.lang = 'en-US'; // en-US to get better male/female voice reading transliteration clearly
  const englishUtter = new SpeechSynthesisUtterance(englishText);
  englishUtter.lang = 'en-IN';
  tamilUtter.onend = () => { if (onEnd) onEnd(); synth.speak(englishUtter); };
  synth.speak(tamilUtter);
}

const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
if (!SpeechRecognition) alert('Speech Recognition not supported on your browser.');

function createRecognition() {
  const rec = new SpeechRecognition();
  rec.lang = 'en-IN';
  rec.interimResults = false;
  rec.maxAlternatives = 1;
  return rec;
}

// Setup voice input buttons and prompts with correct Tamil transliteration phrases
function setupVoice(buttonId, inputId, tamilPrompt, englishPrompt) {
  const btn = document.getElementById(buttonId);
  const input = document.getElementById(inputId);

  btn.onclick = () => {
    speakPrompt(tamilPrompt, englishPrompt, () => {
      const recognition = createRecognition();
      recognition.start();

      recognition.onresult = e => {
        input.value = e.results[0][0].transcript;
        recognition.stop();
      };
      recognition.onerror = () => recognition.stop();
    });
  };
}

setupVoice('voiceName', 'name', 'ungal paiyaru sollavum', 'Please say your name');
setupVoice('voiceLocation', 'location', 'pannaiyin edathai sollavum', 'Please say your farm location');
setupVoice('voiceSubsidy', 'subsidyType', 'yendha salugai vendum', 'Please say the subsidy type');
setupVoice('voiceAmount', 'amount', 'ungaluku vendiya thogai sollavum', 'Please say the amount');
setupVoice('voiceSubsidy', 'subsidyType', 'yendha salugai vendum', 'Please say the subsidy type');

form.onsubmit = e => {
  e.preventDefault();
  if (!form.name.value || !form.location.value || !form.subsidyType.value || !form.amount.value || !aadhaarInput.value) {
    alert('Please fill all fields including Aadhaar number.');
    return;
  }
  alert(`Form Submitted:
Name: ${form.name.value}
Location: ${form.location.value}
Subsidy: ${form.subsidyType.value}
Amount: ${form.amount.value}
Aadhaar: ${aadhaarInput.value}`);
};
</script>
</body>
</html>
